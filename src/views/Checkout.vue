<template>
    <div class="container">
        <Carousel
            :entries="request.paymentOptions.map((paymentOptions) => paymentOptions.currency)"
            :animationDuration="500"
            :selected="selectedCurrency"
            :disabled="choosenCurrency !== null"
            @select="updateSelection">
            <template v-for="paymentOptions of request.paymentOptions" v-slot:[paymentOptions.currency]>
                <NimiqCheckoutOption
                    v-if="paymentOptions.currency === Currency.NIM"
                    :paymentOptions="paymentOptions"
                    :key="paymentOptions.currency"
                    :class="{confirmed: choosenCurrency === paymentOptions.currency}"
                    @chosen="chooseCurrency"
                    @expired="expired"/>
                <EthereumCheckoutOption
                    v-else-if="paymentOptions.currency === Currency.ETH"
                    :paymentOptions="paymentOptions"
                    :key="paymentOptions.currency"
                    :class="{confirmed: choosenCurrency === paymentOptions.currency}"
                    @chosen="chooseCurrency"
                    @expired="expired"/>
                <BitcoinCheckoutOption
                    v-else-if="paymentOptions.currency === Currency.BTC"
                    :paymentOptions="paymentOptions"
                    :key="paymentOptions.currency"
                    :class="{confirmed: choosenCurrency === paymentOptions.currency}"
                    @chosen="chooseCurrency"
                    @expired="expired"/>
            </template>
        </Carousel>

        <button class="global-close nq-button-s" @click="close">
            <ArrowLeftSmallIcon/>
            Cancel Payment
        </button>
    </div>
</template>

<script lang="ts">
import { Component, Vue } from 'vue-property-decorator';
import { Carousel, ArrowLeftSmallIcon } from '@nimiq/vue-components';
import { ParsedCheckoutRequest } from '../lib/RequestTypes';
import BitcoinCheckoutOption from '../components/BitcoinCheckoutOption.vue';
import EthereumCheckoutOption from '../components/EthereumCheckoutOption.vue';
import NimiqCheckoutOption from '../components/NimiqCheckoutOption.vue';
import { Currency } from '../lib/PublicRequestTypes';
import { State as RpcState } from '@nimiq/rpc';
import staticStore, { Static } from '../lib/StaticStore';
import { ERROR_CANCELED } from '../lib/Constants';

@Component({components: {
    ArrowLeftSmallIcon,
    Carousel,
    BitcoinCheckoutOption,
    EthereumCheckoutOption,
    NimiqCheckoutOption,
}})
export default class Checkout extends Vue {

    @Static private rpcState!: RpcState;
    @Static private request!: ParsedCheckoutRequest;
    private choosenCurrency: Currency | null = null;
    private selectedCurrency: Currency = Currency.NIM;
    private availableCurrencies: Set<Currency> = new Set<Currency>();

    private async created() {
        const $subtitle = document.querySelector('.logo .logo-subtitle')!;
        $subtitle.textContent = 'Checkout';
        this.request.paymentOptions.forEach((option) => this.availableCurrencies.add(option.currency));
        document.title = 'Nimiq Checkout';
    }

    private close() {
        this.$rpc.reject(new Error(ERROR_CANCELED));
    }

    private updateSelection(selectedCurrency: string) {
        this.selectedCurrency = selectedCurrency as Currency;
    }

    private chooseCurrency(currency: Currency) {
        this.choosenCurrency = currency;
    }

    private expired(currency: Currency) {
        this.availableCurrencies.delete(currency);
        if (this.availableCurrencies.size === 0 || this.choosenCurrency === currency) {
            this.choosenCurrency = currency;
            return;
        }
        if (this.selectedCurrency === currency) {
            this.selectedCurrency = this.availableCurrencies.values().next().value;
        }
    }

    private data() {
        return {
            Currency,
        };
    }
}
</script>

<style scoped>
    .container >>> .small-page {
        position: relative;
    }

    .container >>> .nq-h1 {
        margin-top: 3.5rem;
        margin-bottom: 1rem;
        line-height: 1;
        text-align: center;
    }

    .carousel {
        width: 100%;
        box-sizing: border-box;
        padding: 0;
        overflow: hidden;
    }

    .carousel >>> .payment-option {
        transition: filter .5s ease;
        padding: 4rem 0;
    }

    .carousel >>> > :not(.selected) .payment-option {
        -webkit-filter: grayscale(100%); /* Safari 6.0 - 9.0 */
        filter: grayscale(100%);
    }

    .carousel >>> .currency-info {
        display: flex;
        flex-direction: column;
        align-items: center;
        transition: transform .5s cubic-bezier(.67,0,.16,1), opacity .25s var(--nimiq-ease);
        transform: translateY(0rem);
    }

    .carousel >>> > :not(.selected) .currency-info {
        transform: translateY(-6rem);
    }

    /* make empty padding in cards click though to cards behind */
    .carousel >>> > * {
        pointer-events: none;
    }
    .carousel >>> .currency-info > *,
    .carousel >>> .nq-card {
        pointer-events: all !important;
    }

    .carousel.disabled >>> > :not(.selected) .currency-info {
        opacity: 0;
    }
</style>
